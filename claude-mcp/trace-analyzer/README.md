# Metabase Trace Analyzer MCP Server

This directory contains a Claude Code Stdio MCP (Model Context Protocol) server that analyzes Clojure trace files generated by Metabase's tracing utilities. The server allows Claude to extract insights from trace files, helping to understand execution flows and debug complex issues.

## Features

- **Namespace Analysis**: Find all function calls from specific namespaces in a trace file
- **Function Analysis**: Find specific function calls in a trace file
- **Call Hierarchy**: Visualize the call stack and function relationships
- **Statistics**: Get aggregate information about function calls and namespaces

## Installation

1. The server is already built and installed in this directory. To use it with Claude, run:

```bash
claude mcp add trace-analyzer -- npx ts-node /Users/tplude/code/metabase/claude-mcp/trace-analyzer/server.ts
```

2. After adding the MCP server to Claude, you can use the `/mcp` command to check connectivity:

```
/mcp
```

This should show:
```
MCP Server Status (Debug Mode)
â€¢ trace-analyzer: connected
```

## Usage Examples

### Analyzing Namespace Calls

Use the `analyze_namespace_calls` tool to find function calls from specific namespaces:

```
mcp__trace-analyzer__analyze_namespace_calls(
  trace_file: "/Users/tplude/code/metabase/card-dashboard-dataset.trace",
  namespaces: ["metabase.api.dashboard"],
  limit: 50,
  include_returns: true
)
```

### Analyzing Function Calls

Use the `analyze_function_calls` tool to find specific function calls:

```
mcp__trace-analyzer__analyze_function_calls(
  trace_file: "/Users/tplude/code/metabase/card-dashboard-dataset.trace",
  function_names: ["dashboard/hydrate-dashboard-details", "dashboard/get-dashboard"],
  limit: 20,
  include_returns: true
)
```

### Getting Trace Statistics

Use the `get_trace_statistics` tool to get aggregate information about a trace file:

```
mcp__trace-analyzer__get_trace_statistics(
  trace_file: "/Users/tplude/code/metabase/card-dashboard-dataset.trace",
  max_sample: 5000
)
```

## Available Tools

### analyze_namespace_calls

Finds function calls from specific namespaces in a trace file.

Parameters:
- `trace_file`: Path to the trace file to analyze
- `namespaces`: List of namespaces to filter for (e.g. ["metabase.api", "metabase.query-processor"])
- `limit`: Maximum number of results to return (default: 100)
- `include_returns`: Whether to include return values in the output (default: true)
- `show_hierarchy`: Whether to show the call hierarchy (default: false)

### analyze_function_calls

Finds specific function calls in a trace file.

Parameters:
- `trace_file`: Path to the trace file to analyze
- `function_names`: List of function names to filter for (can include namespace, e.g. ["dashboard/get-dashboard", "card/create-card"])
- `limit`: Maximum number of results to return (default: 100)
- `include_returns`: Whether to include return values in the output (default: true)
- `show_hierarchy`: Whether to show the call hierarchy (default: false)

### get_trace_statistics

Gets aggregate information about a trace file.

Parameters:
- `trace_file`: Path to the trace file to analyze
- `max_sample`: Maximum number of lines to sample for statistics (default: 10000)

## How It Works

The Trace Analyzer works with trace files generated by Metabase's tracing utilities. These files log function entry and exit points with their respective call depths, allowing the analyzer to reconstruct the call stack and function relationships.

The server efficiently streams through trace files, allowing analysis of large trace files without loading everything into memory.

## Generating Trace Files

Trace files can be generated using the functions in `dev/src/trace.clj`:

```clojure
(require '[tsp.trace :as trace])

;; Trace a namespace
(trace/instrument "metabase.api.dashboard" :output-file "/tmp/dashboard.trace")

;; Trace multiple namespaces
(trace/instrument-multi ["metabase.api.dashboard" "metabase.api.card"] 
                       "/tmp/dashboard-card.trace")

;; Stop tracing
(trace/uninstrument "metabase.api.dashboard")
```

After executing operations that involve the traced namespaces, the trace file will contain detailed function call information that can be analyzed with this MCP server.