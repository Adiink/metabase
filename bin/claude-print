#!/bin/bash

if [ $# -eq 0 ]; then
    echo "Usage: claude-print <prompt>"
    echo "  Launches Claude in non-interactive mode with Metabase-specific tools and the given prompt."
    exit 1
fi

# Uncomment if you want to debug the script invocation
# set -o xtrace

# JSON output will be in claude-print-output.json
# suggested in https://github.com/anthropics/claude-code/issues/733#issuecomment-2790100083
yarn --silent claude --print --output-format stream-json "$(printf "%q " "$@")" --allowedTools "Bash(./bin/mage:*)" "Bash(clj-kondo:*)" "Bash(clojure:*)", "Bash(grep:*)" "Bash(ls:*)" "Bash(yarn lint:*)" "Bash(yarn test-unit:*)" "WebFetchTool(domain:github.com)" "Bash(git:*)" "Bash(gh:*)" Edit  | tee claude-print-output.json | jq -r '
  if .content != null and (.content | type) == "array" then
    # Extract text content
    (.content[] | select(.type == "text") | "TEXT: " + .text),
    # Extract tool use
    (.content[] | select(.type == "tool_use") | "TOOL: " + (.name) + " - " + (.input|tostring))
  else empty
  end'
